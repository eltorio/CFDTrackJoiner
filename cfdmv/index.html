<html>
    <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/blue.css">
    <script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@nano-sql/core@2.3.7/dist/nano-sql.min.js'></script>
    <script src='js/igc-parser.js'></script>
    <script src='js/fit-parser.js'></script>
    <script src='js/gpx-parser.js'></script>    
    <script src='js/trackjoiner.js'></script>
    <script>

  // for debug purposes
  var showDB = function(){
    getDBTracksRowsAsPromise().then((rows) => {
                      // selected rows
                      console.log(rows);
                  }).catch((error) => {
                    console.log(error.toString());
                  });
    getDBFixesRowsAsPromise().then((rows) => {
                      // selected rows
                      console.log(rows);
                  }).catch((error) => {
                    console.log(error.toString());
                  });                  
    }

// Main logic
    var showHTMLTable = function(tableId){
      $(tableId + " tbody").empty();
      var options = { year: '2-digit', month: 'short', day: '2-digit', hour:'numeric', minute:'numeric', second:'numeric'};
      getDBTracksRowsAsPromise().then((rows) => {
                        for (var i=0; i<rows.length;i++){
                                    var dt_start = new Intl.DateTimeFormat('fr-FR', options).format(new Date(rows[i].dt_start));
                                    var dt_end = new Intl.DateTimeFormat('fr-FR', options).format(new Date(rows[i].dt_end));
                                    $(`${tableId}> tbody:last-child`).append(`<tr><td>${i}</td><td>${dt_start}</td><td>${dt_end}</td><td>${rows[i].nb_fixes}</td><td>${rows[i].name}</td><td>${rows[i].type}</td><td>${rows[i].id}</td></tr>`);
                                  };
                  }).catch((error) => {
                    console.log(error.toString());
                  });
    };

    //creates a pseudo "download" link for saving the produced IGC
    var downloadIGCFile = function (filename, text) {
          var theDownloadlink = $('<a>',{
                          text: 'Clic and save the generated file',
                          title: 'Download file',
                          href: 'data:octet/stream;charset=utf-8,' + encodeURIComponent(text),
                          download: filename
                      }).appendTo('#downloadLink');

        };

    // Just make a html table with the content of the DB table tracks
    var insertDBCallback = function(){
      showHTMLTable("#parsedTable");
      $('#joinBtn').removeAttr('disabled');
    };

    // Don't forget that nSQL().query() return a Promise because of its asynchronous conception
    // promised_rows is in order [tracksQueryPromise,fixesQueryPromise]
    var promisedDBRows = function(promised_rows){
          var tracks_rows = promised_rows[0];
          var fixes_rows = promised_rows[1];
          var valid = !isAnOverlapDetected(tracks_rows); //negative logic !
          if (valid){
            var igcString = igcProducer(fixes_rows);
            $("#igcResult").html(igcString);;
            downloadIGCFile("TEMP.IGC", igcString);
            $('#joinBtn').removeAttr('disabled');
          }else{
            $("#igcResult").html("<h1 style='color: #FF0000'><b>OVERLAP DETECTED</b></h1>");
            $('#joinBtn').attr("disabled", true);
          }
        }

   // Retrieves the DB as an IGC file (in a javascript string)
   var getDBasIGCString = function(){
      var tracksQueryPromise = getDBTracksRowsAsPromise();
      var fixesQueryPromise = getDBFixesRowsAsPromise();
      Promise.all([tracksQueryPromise,fixesQueryPromise]).then(promisedDBRows).catch((error) => {
                      console.log(error.toString());
                    });   
   };

    initDB();
    $(window).on('load', function() {
        $('#filesFly').removeAttr('disabled');
        $('#filestHike').removeAttr('disabled');
    });
    </script>
    </head>

    <body>
    <div>
      <p>
      With basic overlapping detection…<br />
      tested only with FIT files from Garmin® 6x Pro, IGC from SkyBean® SkyDrop and GPX files exported from Strava®<br/>
      Please report issue on <a href="https://github.com/eltorio/CFDTrackJoiner/issues">the project page</a>.</p>
      <span id='downloadLink'></span>
      <br/>
    </div>
    <div>
      <p>
      <div>
        <label for="filesFly" class="btn">Fly•ies (FIT,GPX or IGC format)</label>
        <input id="filesFly" type='file' accept='.igc,.fit,.gpx' onchange='openFile(event, trackTypes.FLY, insertDBCallback)' multiple disabled/> 
      </div>
      </p>
  </div>
  <div>
    <p>  
    <div>
      <label for="filestHike" class="btn">Hike•s (FIT,GPX or IGC format)</label>
      <input id="filesHike" type='file' accept='.igc,.fit,.gpx' onchange='openFile(event,trackTypes.HIKE, insertDBCallback)' multiple disabled/>
    </div>  
  </p>
</div>    
    <div>
      <label for="joinBtn" class="btn">Join tracks</label>
      <input id="joinBtn" type='button' onclick='getDBasIGCString()' value="Join" disabled/>
    </div>
    <br>
    <div id='output'>
    <table class="paleBlueRows" id="parsedTable"> 
      <thead>
        <tr><td>Section</td><td>début</td><td>Fin</td><td>Nb Points</td><td>Fichier</td><td>Type</td><td>SHA256</td></tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    </div>
    <pre id='igcResult'>
  </pre>
    </body>
    </html>
